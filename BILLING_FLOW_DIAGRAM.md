# Billing System Flow Diagram

## 🔄 Complete User Flow

```
┌─────────────────────────────────────────────────────────────┐
│                     USER OPENS APP                          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    DASHBOARD SCREEN                         │
│  ┌────────────────────────────────────────────────┐        │
│  │  Quick Actions                                 │        │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐    │        │
│  │  │ Billing  │  │  Add     │  │ Barcode  │    │        │
│  │  │   (POS)  │  │ Product  │  │  Scan    │    │        │
│  │  └──────────┘  └──────────┘  └──────────┘    │        │
│  └────────────────────────────────────────────────┘        │
└─────────────────────────────────────────────────────────────┘
                              │
                     [Tap "Billing"]
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    BILLING SCREEN                           │
│  ┌────────────────────────────────────────────────┐        │
│  │  [Scan Barcode]    [Manual Select]             │        │
│  └────────────────────────────────────────────────┘        │
│                                                             │
│  Cart: Empty                                               │
│  ┌────────────────────────────────────────────────┐        │
│  │         🛒 Cart is empty                        │        │
│  │  Scan barcode or search products to add items  │        │
│  └────────────────────────────────────────────────┘        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │  Add Products?   │
                    └──────────────────┘
                    │                  │
          [Barcode] │                  │ [Manual]
                    ▼                  ▼
         ┌─────────────────┐    ┌──────────────────┐
         │ SCAN BARCODE    │    │ SEARCH PRODUCTS  │
         │                 │    │                  │
         │ 📷 Camera Open  │    │ 🔍 Search Input  │
         │                 │    │                  │
         │ Scan Product    │    │ Type: Name/SKU   │
         │ Barcode         │    │                  │
         └─────────────────┘    │ Results List:    │
                    │            │ - Product 1      │
                    │            │ - Product 2      │
                    │            │ - Product 3      │
                    │            └──────────────────┘
                    │                      │
                    │                      │ [Tap Product]
                    ▼                      ▼
         ┌─────────────────────────────────────────┐
         │  API: GET /products/barcode/:barcode    │
         │  API: GET /products/search?q=...        │
         └─────────────────────────────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │ Product Found?   │
                    └──────────────────┘
                    │                  │
              [Yes] │                  │ [No]
                    ▼                  ▼
         ┌─────────────────┐    ┌─────────────────┐
         │ Check Stock     │    │ Alert: Product  │
         │ Available?      │    │ Not Found       │
         └─────────────────┘    └─────────────────┘
                    │
              [Yes] │
                    ▼
         ┌─────────────────────────────────┐
         │ Already in Cart?                │
         └─────────────────────────────────┘
              │                      │
        [Yes] │                      │ [No]
              ▼                      ▼
    ┌────────────────┐    ┌──────────────────────┐
    │ Increment      │    │ Add New Item to Cart │
    │ Quantity       │    │ Quantity: 1          │
    └────────────────┘    └──────────────────────┘
              │                      │
              └──────────┬───────────┘
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                    CART WITH ITEMS                          │
│  ┌────────────────────────────────────────────────┐        │
│  │  Product 1                              ₹100   │        │
│  │  ₹50 × 2           [-] 2 [+]            [🗑️]    │        │
│  ├────────────────────────────────────────────────┤        │
│  │  Product 2                              ₹150   │        │
│  │  ₹75 × 2           [-] 2 [+]            [🗑️]    │        │
│  └────────────────────────────────────────────────┘        │
│                                                             │
│  ┌────────────────────────────────────────────────┐        │
│  │  Items (4)                          ₹250.00    │        │
│  │  GST (18%)                          ₹45.00     │        │
│  │  ─────────────────────────────────────────     │        │
│  │  Total                              ₹295.00    │        │
│  │                                                 │        │
│  │  [        Pay ₹295.00        ]                 │        │
│  └────────────────────────────────────────────────┘        │
└─────────────────────────────────────────────────────────────┘
                              │
                     [Tap "Pay ₹295.00"]
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   PAYMENT MODAL                             │
│  ┌────────────────────────────────────────────────┐        │
│  │           Total Amount: ₹295.00                │        │
│  │                                                 │        │
│  │  Payment Method:                               │        │
│  │  ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐      │        │
│  │  │ Cash │  │ Card │  │ UPI  │  │Wallet│      │        │
│  │  │  💵  │  │  💳  │  │  📱  │  │  👛  │      │        │
│  │  └──────┘  └──────┘  └──────┘  └──────┘      │        │
│  │                                                 │        │
│  │  [If Cash Selected]                            │        │
│  │  Amount Received: [______]                     │        │
│  │  Change: ₹5.00                                 │        │
│  │                                                 │        │
│  │  [      Complete Payment      ]                │        │
│  └────────────────────────────────────────────────┘        │
└─────────────────────────────────────────────────────────────┘
                              │
                     [Tap "Complete Payment"]
                              ▼
┌─────────────────────────────────────────────────────────────┐
│           BACKEND: Process Sale with FIFO                   │
│                                                             │
│  POST /api/v1/inventory/sales                              │
│  {                                                          │
│    saleItems: [                                            │
│      { productId: "xxx", quantity: 2 },                    │
│      { productId: "yyy", quantity: 2 }                     │
│    ],                                                       │
│    referenceNumber: "BILL-1728384920123"                   │
│  }                                                          │
│                                                             │
│  ▼                                                          │
│  BatchService.processSaleFIFO()                            │
│  ┌─────────────────────────────────────────┐              │
│  │ For Each Product:                       │              │
│  │  1. Get active batches (FIFO order)     │              │
│  │  2. Select oldest batches first         │              │
│  │  3. Deduct from batches                 │              │
│  │  4. Calculate cost & profit             │              │
│  │  5. Update inventory                    │              │
│  │  6. Create stock movement records       │              │
│  └─────────────────────────────────────────┘              │
│                                                             │
│  Example:                                                  │
│  Product 1 (2 units needed):                               │
│    Batch A (Oct 1): 1 unit @ ₹40 → Used                   │
│    Batch B (Oct 5): 1 unit @ ₹42 → Used                   │
│    Cost: ₹82, Revenue: ₹100, Profit: ₹18                  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │ Sale Successful? │
                    └──────────────────┘
                    │                  │
              [Yes] │                  │ [No]
                    ▼                  ▼
         ┌─────────────────┐    ┌─────────────────┐
         │ Generate        │    │ Show Error      │
         │ Receipt         │    │ Alert           │
         └─────────────────┘    └─────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│                   RECEIPT MODAL                             │
│  ┌────────────────────────────────────────────────┐        │
│  │             ✅ Payment Successful!              │        │
│  │                                                 │        │
│  │  Bill No: BILL-1728384920123                   │        │
│  │  Date: Oct 8, 2024 3:45 PM                     │        │
│  │  Cashier: John Doe                             │        │
│  │  ────────────────────────────────────          │        │
│  │  Product 1 × 2              ₹100.00            │        │
│  │  Product 2 × 2              ₹150.00            │        │
│  │  ────────────────────────────────────          │        │
│  │  Subtotal                   ₹250.00            │        │
│  │  GST (18%)                  ₹45.00             │        │
│  │  Total                      ₹295.00            │        │
│  │  ────────────────────────────────────          │        │
│  │  Payment: Cash                                 │        │
│  │  Received: ₹300.00                             │        │
│  │  Change: ₹5.00                                 │        │
│  │                                                 │        │
│  │  [Print Receipt]      [Done]                   │        │
│  └────────────────────────────────────────────────┘        │
└─────────────────────────────────────────────────────────────┘
                              │
                     [Tap "Done"]
                              ▼
┌─────────────────────────────────────────────────────────────┐
│              BILLING SCREEN (Cart Cleared)                  │
│  ┌────────────────────────────────────────────────┐        │
│  │  [Scan Barcode]    [Manual Select]             │        │
│  └────────────────────────────────────────────────┘        │
│                                                             │
│  Cart: Empty                                               │
│  🎉 Ready for next transaction!                            │
└─────────────────────────────────────────────────────────────┘
```

## 🔄 FIFO Batch Selection Flow

```
┌─────────────────────────────────────────────────────────────┐
│           FIFO BATCH SELECTION PROCESS                      │
└─────────────────────────────────────────────────────────────┘

Product: Milk Carton
Need to sell: 7 units
Current Stock: 10 units

┌─────────────────────────────────────────────────────────────┐
│  Available Batches (Sorted by Purchase Date):               │
│                                                             │
│  ┌───────────────────────────────────────────────┐         │
│  │ Batch 1                                       │         │
│  │ Purchase Date: Oct 1, 2024                    │         │
│  │ Quantity: 5 units                             │         │
│  │ Cost Price: ₹40 per unit                      │         │
│  │ Selling Price: ₹50 per unit                   │         │
│  └───────────────────────────────────────────────┘         │
│                                                             │
│  ┌───────────────────────────────────────────────┐         │
│  │ Batch 2                                       │         │
│  │ Purchase Date: Oct 5, 2024                    │         │
│  │ Quantity: 3 units                             │         │
│  │ Cost Price: ₹42 per unit                      │         │
│  │ Selling Price: ₹50 per unit                   │         │
│  └───────────────────────────────────────────────┘         │
│                                                             │
│  ┌───────────────────────────────────────────────┐         │
│  │ Batch 3                                       │         │
│  │ Purchase Date: Oct 8, 2024                    │         │
│  │ Quantity: 2 units                             │         │
│  │ Cost Price: ₹45 per unit                      │         │
│  │ Selling Price: ₹50 per unit                   │         │
│  └───────────────────────────────────────────────┘         │
└─────────────────────────────────────────────────────────────┘

                              │
                              ▼
                    [Need 7 units]
                              │
                              ▼

┌─────────────────────────────────────────────────────────────┐
│  Step 1: Use Batch 1 (Oldest)                               │
│  ┌───────────────────────────────────────────────┐         │
│  │ Take: 5 units                                 │         │
│  │ Cost: 5 × ₹40 = ₹200                          │         │
│  │ Revenue: 5 × ₹50 = ₹250                       │         │
│  │ Remaining needed: 7 - 5 = 2 units             │         │
│  │ Batch 1 Status: Depleted ✓                    │         │
│  └───────────────────────────────────────────────┘         │
└─────────────────────────────────────────────────────────────┘

                              │
                              ▼
                    [Still need 2 units]
                              │
                              ▼

┌─────────────────────────────────────────────────────────────┐
│  Step 2: Use Batch 2 (Next Oldest)                          │
│  ┌───────────────────────────────────────────────┐         │
│  │ Take: 2 units (out of 3 available)            │         │
│  │ Cost: 2 × ₹42 = ₹84                           │         │
│  │ Revenue: 2 × ₹50 = ₹100                       │         │
│  │ Remaining needed: 2 - 2 = 0 units ✓           │         │
│  │ Batch 2 Status: Partially used (1 left)       │         │
│  └───────────────────────────────────────────────┘         │
└─────────────────────────────────────────────────────────────┘

                              │
                              ▼
                    [All units fulfilled]
                              │
                              ▼

┌─────────────────────────────────────────────────────────────┐
│  Final Calculation:                                         │
│  ┌───────────────────────────────────────────────┐         │
│  │ Total Units Sold: 7                           │         │
│  │                                                │         │
│  │ Total Cost:                                    │         │
│  │   Batch 1: 5 × ₹40 = ₹200                     │         │
│  │   Batch 2: 2 × ₹42 = ₹84                      │         │
│  │   Total Cost = ₹284                           │         │
│  │                                                │         │
│  │ Total Revenue:                                 │         │
│  │   7 × ₹50 = ₹350                              │         │
│  │                                                │         │
│  │ Profit:                                        │         │
│  │   ₹350 - ₹284 = ₹66                           │         │
│  │                                                │         │
│  │ Profit Margin:                                 │         │
│  │   (₹66 / ₹350) × 100 = 18.86%                 │         │
│  │                                                │         │
│  │ Average Cost Price: ₹284 / 7 = ₹40.57         │         │
│  └───────────────────────────────────────────────┘         │
└─────────────────────────────────────────────────────────────┘

                              │
                              ▼

┌─────────────────────────────────────────────────────────────┐
│  Updated Inventory:                                         │
│                                                             │
│  ✗ Batch 1: Depleted (0 units)                             │
│  ✓ Batch 2: 1 unit remaining                               │
│  ✓ Batch 3: 2 units (untouched)                            │
│                                                             │
│  Product Current Stock: 10 → 3 units                        │
└─────────────────────────────────────────────────────────────┘
```

## 📊 Stock Movement Records Created

```
┌─────────────────────────────────────────────────────────────┐
│  Stock Movement 1:                                          │
│  ┌───────────────────────────────────────────────┐         │
│  │ Product: Milk Carton                          │         │
│  │ Movement Type: Sale                           │         │
│  │ Quantity: -5                                  │         │
│  │ Batch Number: BATCH24100101                   │         │
│  │ Unit Cost: ₹40                                │         │
│  │ Total Cost: ₹200                              │         │
│  │ Previous Stock: 10                            │         │
│  │ New Stock: 5                                  │         │
│  │ Reference: BILL-1728384920123                 │         │
│  │ Created By: John Doe                          │         │
│  └───────────────────────────────────────────────┘         │
│                                                             │
│  Stock Movement 2:                                          │
│  ┌───────────────────────────────────────────────┐         │
│  │ Product: Milk Carton                          │         │
│  │ Movement Type: Sale                           │         │
│  │ Quantity: -2                                  │         │
│  │ Batch Number: BATCH24100501                   │         │
│  │ Unit Cost: ₹42                                │         │
│  │ Total Cost: ₹84                               │         │
│  │ Previous Stock: 5                             │         │
│  │ New Stock: 3                                  │         │
│  │ Reference: BILL-1728384920123                 │         │
│  │ Created By: John Doe                          │         │
│  └───────────────────────────────────────────────┘         │
└─────────────────────────────────────────────────────────────┘
```

## 🔄 Error Handling Flow

```
                    ┌──────────────────┐
                    │  User Action     │
                    └──────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │  Validation      │
                    └──────────────────┘
                    │                  │
              [Pass]│                  │[Fail]
                    ▼                  ▼
         ┌─────────────────┐    ┌─────────────────┐
         │ Process Request │    │ Show Error      │
         │                 │    │ Alert           │
         └─────────────────┘    │                 │
                    │            │ Examples:       │
                    │            │ • No stock      │
                    │            │ • Invalid $     │
                    │            │ • Not found     │
                    │            └─────────────────┘
                    ▼
            ┌───────────────┐
            │ API Call      │
            └───────────────┘
                    │
                    ▼
            ┌───────────────┐
            │ Success?      │
            └───────────────┘
            │              │
      [Yes] │              │ [No]
            ▼              ▼
    ┌──────────┐    ┌─────────────┐
    │ Show     │    │ Show Error  │
    │ Success  │    │ Rollback    │
    └──────────┘    └─────────────┘
```

---

**Legend:**
- 📱 = Mobile Action
- 🔄 = Process/Flow
- ✅ = Success
- ❌ = Error/Failure
- 📊 = Data/Calculation
- 🛒 = Shopping Cart
- 💰 = Payment
- 🧾 = Receipt

